<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音量控制测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-section h2 {
            color: #666;
            margin-bottom: 15px;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        .volume-slider {
            flex: 1;
        }
        .volume-display {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: #333;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .code-preview {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.worker {
            color: #68d391;
        }
        .log-entry.main {
            color: #63b3ed;
        }
        .log-entry.sound {
            color: #f6ad55;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 音量控制测试</h1>
        
        <div class="test-section">
            <h2>📊 音量控制</h2>
            <p>测试音量设置和获取功能</p>
            
            <div class="volume-control">
                <label>音量:</label>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100">
                <span class="volume-display" id="volumeDisplay">100%</span>
            </div>
            
            <div class="volume-control">
                <label>音量变化:</label>
                <input type="range" class="volume-slider" id="volumeChangeSlider" min="-100" max="100" value="0">
                <span class="volume-display" id="volumeChangeDisplay">0</span>
            </div>
            
            <button class="test-button" onclick="testSetVolume()">设置音量</button>
            <button class="test-button" onclick="testGetVolume()">获取音量</button>
            <button class="test-button" onclick="testChangeVolume()">改变音量</button>
            <button class="test-button" onclick="testVolumeLoop()">音量循环测试</button>
            
            <div class="code-preview">// 测试代码
setVolume(50);           // 设置音量为50%
getVolume();             // 获取当前音量
setVolume(getVolume() + 10);  // 增加10%音量</div>
            
            <div id="volume-status" class="status"></div>
        </div>

        <div class="test-section">
            <h2>🎵 声音播放测试</h2>
            <p>测试音量对声音播放的影响</p>
            
            <button class="test-button" onclick="playTestSound()">播放测试声音</button>
            <button class="test-button" onclick="stopTestSound()">停止声音</button>
            <button class="test-button" onclick="testVolumeWithSound()">音量+声音测试</button>
            
            <div id="sound-status" class="status"></div>
        </div>

        <div class="test-section">
            <h2>🔧 调试信息</h2>
            <p>查看音量控制的详细日志</p>
            
            <button class="test-button" onclick="clearLog()">清除日志</button>
            <button class="test-button" onclick="exportLog()">导出日志</button>
            
            <div class="log-container" id="logContainer">
                <div class="log-entry">🎵 音量控制测试页面已加载</div>
            </div>
        </div>
    </div>

    <script>
        // 模拟音量控制函数
        let currentVolume = 100;
        let testAudio = null;
        let logEntries = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logEntries.push({ message: logEntry, type });
            
            const logContainer = document.getElementById('logContainer');
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${type}`;
            logElement.textContent = logEntry;
            logContainer.appendChild(logElement);
            
            // 自动滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function updateVolumeDisplay() {
            document.getElementById('volumeDisplay').textContent = `${currentVolume}%`;
            document.getElementById('volumeSlider').value = currentVolume;
        }

        // 模拟 setVolume 函数
        function setVolume(volume) {
            const oldVolume = currentVolume;
            currentVolume = Math.max(0, Math.min(100, volume));
            
            addLog(`🎵 设置音量: ${oldVolume}% → ${currentVolume}%`, 'sound');
            
            // 如果有测试音频，更新其音量
            if (testAudio) {
                testAudio.volume = currentVolume / 100;
                addLog(`🎵 更新测试音频音量: ${currentVolume}%`, 'sound');
            }
            
            updateVolumeDisplay();
            return currentVolume;
        }

        // 模拟 getVolume 函数
        function getVolume() {
            addLog(`🎵 获取音量: ${currentVolume}%`, 'sound');
            return currentVolume;
        }

        function testSetVolume() {
            try {
                const volume = parseInt(document.getElementById('volumeSlider').value);
                setVolume(volume);
                updateStatus('volume-status', `✅ 音量设置成功！当前音量: ${currentVolume}%`, 'success');
            } catch (error) {
                updateStatus('volume-status', `❌ 音量设置失败: ${error.message}`, 'error');
            }
        }

        function testGetVolume() {
            try {
                const volume = getVolume();
                updateStatus('volume-status', `✅ 音量获取成功！当前音量: ${volume}%`, 'success');
            } catch (error) {
                updateStatus('volume-status', `❌ 音量获取失败: ${error.message}`, 'error');
            }
        }

        function testChangeVolume() {
            try {
                const change = parseInt(document.getElementById('volumeChangeSlider').value);
                const newVolume = setVolume(getVolume() + change);
                updateStatus('volume-status', `✅ 音量改变成功！变化: ${change}%, 新音量: ${newVolume}%`, 'success');
            } catch (error) {
                updateStatus('volume-status', `❌ 音量改变失败: ${error.message}`, 'error');
            }
        }

        function testVolumeLoop() {
            try {
                addLog('🔄 开始音量循环测试', 'info');
                
                // 模拟循环测试
                for (let i = 0; i <= 100; i += 10) {
                    setVolume(i);
                    const retrievedVolume = getVolume();
                    if (retrievedVolume !== i) {
                        throw new Error(`音量不匹配: 设置${i}%, 获取${retrievedVolume}%`);
                    }
                }
                
                updateStatus('volume-status', `✅ 音量循环测试成功！所有音量值都正确`, 'success');
                addLog('✅ 音量循环测试完成', 'success');
            } catch (error) {
                updateStatus('volume-status', `❌ 音量循环测试失败: ${error.message}`, 'error');
                addLog(`❌ 音量循环测试失败: ${error.message}`, 'error');
            }
        }

        function playTestSound() {
            try {
                // 创建测试音频（使用Web Audio API生成一个简单的音调）
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4音
                oscillator.type = 'sine';
                
                // 设置音量
                gainNode.gain.setValueAtTime(currentVolume / 100, audioContext.currentTime);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 2); // 播放2秒
                
                testAudio = { oscillator, gainNode, audioContext };
                
                updateStatus('sound-status', `✅ 测试声音播放成功！音量: ${currentVolume}%`, 'success');
                addLog(`🎵 播放测试声音，音量: ${currentVolume}%`, 'sound');
            } catch (error) {
                updateStatus('sound-status', `❌ 测试声音播放失败: ${error.message}`, 'error');
                addLog(`❌ 测试声音播放失败: ${error.message}`, 'error');
            }
        }

        function stopTestSound() {
            try {
                if (testAudio) {
                    testAudio.oscillator.stop();
                    testAudio = null;
                    updateStatus('sound-status', `✅ 测试声音已停止`, 'success');
                    addLog(`🎵 测试声音已停止`, 'sound');
                } else {
                    updateStatus('sound-status', `ℹ️ 没有正在播放的测试声音`, 'info');
                }
            } catch (error) {
                updateStatus('sound-status', `❌ 停止测试声音失败: ${error.message}`, 'error');
            }
        }

        function testVolumeWithSound() {
            try {
                addLog('🎵 开始音量+声音测试', 'sound');
                
                // 播放声音并测试不同音量
                const volumes = [100, 50, 25, 10, 0];
                
                volumes.forEach((volume, index) => {
                    setTimeout(() => {
                        setVolume(volume);
                        playTestSound();
                        addLog(`🎵 测试音量 ${volume}%`, 'sound');
                    }, index * 3000); // 每3秒测试一个音量
                });
                
                updateStatus('sound-status', `✅ 音量+声音测试已启动，将依次测试: ${volumes.join('%, ')}%`, 'success');
            } catch (error) {
                updateStatus('sound-status', `❌ 音量+声音测试失败: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            logEntries = [];
            addLog('🧹 日志已清除', 'info');
        }

        function exportLog() {
            const logText = logEntries.map(entry => entry.message).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `volume-test-log-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addLog('📁 日志已导出', 'info');
        }

        // 事件监听器
        document.getElementById('volumeSlider').addEventListener('input', function() {
            document.getElementById('volumeDisplay').textContent = `${this.value}%`;
        });

        document.getElementById('volumeChangeSlider').addEventListener('input', function() {
            document.getElementById('volumeChangeDisplay').textContent = this.value;
        });

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateVolumeDisplay();
            addLog('🎵 音量控制测试页面已初始化', 'info');
            updateStatus('volume-status', '📊 音量控制测试已准备就绪', 'info');
            updateStatus('sound-status', '🎵 声音播放测试已准备就绪', 'info');
        });
    </script>
</body>
</html> 