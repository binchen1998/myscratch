<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声音积木修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>声音积木修复测试</h1>
    
    <div class="test-section">
        <h2>测试1：代码生成器检查</h2>
        <button onclick="testCodeGenerators()">检查代码生成器</button>
        <div id="result1" class="result">结果将在这里显示...</div>
    </div>
    
    <div class="test-section">
        <h2>测试2：声音积木代码生成</h2>
        <button onclick="testSoundBlockGeneration()">测试声音积木代码生成</button>
        <div id="result2" class="result">结果将在这里显示...</div>
    </div>
    
    <div class="test-section">
        <h2>测试3：模拟完整流程</h2>
        <button onclick="testFullFlow()">测试完整流程</button>
        <div id="result3" class="result">结果将在这里显示...</div>
    </div>

    <script>
        function log(elementId, message, isSuccess = null) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (isSuccess === true) {
                element.className = 'result success';
            } else if (isSuccess === false) {
                element.className = 'result error';
            } else {
                element.className = 'result';
            }
            
            element.textContent += logMessage;
            console.log(message);
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
            document.getElementById(elementId).className = 'result';
        }
        
        // 测试1：代码生成器检查
        function testCodeGenerators() {
            clearLog('result1');
            log('result1', '开始检查代码生成器...');
            
            // 检查Blockly是否可用
            if (typeof Blockly === 'undefined') {
                log('result1', '❌ Blockly未加载', false);
                return;
            }
            log('result1', '✅ Blockly已加载');
            
            // 检查声音积木的代码生成器
            const soundBlockTypes = [
                'sound_play',
                'sound_play_wait', 
                'sound_stop_all',
                'sound_change_effect',
                'sound_set_effect',
                'sound_clear_effects',
                'sound_change_volume',
                'sound_set_volume',
                'sound_volume'
            ];
            
            soundBlockTypes.forEach(blockType => {
                if (Blockly.JavaScript[blockType]) {
                    log('result1', `✅ ${blockType} 代码生成器可用`);
                } else {
                    log('result1', `❌ ${blockType} 代码生成器不可用`, false);
                }
            });
            
            log('result1', '代码生成器检查完成');
        }
        
        // 测试2：声音积木代码生成
        function testSoundBlockGeneration() {
            clearLog('result2');
            log('result2', '开始测试声音积木代码生成...');
            
            if (typeof Blockly === 'undefined') {
                log('result2', '❌ Blockly未加载，无法测试', false);
                return;
            }
            
            // 模拟声音积木的代码生成
            try {
                // 测试 playSoundByName 函数是否可用
                if (typeof playSoundByName === 'function') {
                    log('result2', '✅ playSoundByName 函数可用');
                } else {
                    log('result2', '❌ playSoundByName 函数不可用', false);
                }
                
                // 测试 stopAllSounds 函数是否可用
                if (typeof stopAllSounds === 'function') {
                    log('result2', '✅ stopAllSounds 函数可用');
                } else {
                    log('result2', '❌ stopAllSounds 函数不可用', false);
                }
                
                // 测试 setVolume 函数是否可用
                if (typeof setVolume === 'function') {
                    log('result2', '✅ setVolume 函数可用');
                } else {
                    log('result2', '❌ setVolume 函数不可用', false);
                }
                
                // 测试 getVolume 函数是否可用
                if (typeof getVolume === 'function') {
                    log('result2', '✅ getVolume 函数可用');
                } else {
                    log('result2', '❌ getVolume 函数不可用', false);
                }
                
                // 测试声音列表函数是否可用
                if (typeof getSoundsList === 'function') {
                    log('result2', '✅ getSoundsList 函数可用');
                    const sounds = getSoundsList();
                    log('result2', `当前声音列表: ${sounds.length} 个声音`);
                    sounds.forEach(sound => {
                        log('result2', `  - ${sound.name} (ID: ${sound.id})`);
                    });
                } else {
                    log('result2', '❌ getSoundsList 函数不可用', false);
                }
                
            } catch (error) {
                log('result2', `❌ 测试过程中出错: ${error.message}`, false);
            }
            
            log('result2', '声音积木代码生成测试完成');
        }
        
        // 测试3：模拟完整流程
        function testFullFlow() {
            clearLog('result3');
            log('result3', '开始测试完整流程...');
            
            // 模拟代码生成流程
            try {
                log('result3', '1. 检查Blockly代码生成器...');
                if (Blockly.JavaScript['sound_play']) {
                    log('result3', '   ✅ sound_play 代码生成器可用');
                } else {
                    log('result3', '   ❌ sound_play 代码生成器不可用', false);
                }
                
                log('result3', '2. 检查声音管理函数...');
                if (typeof getSoundsList === 'function') {
                    const sounds = getSoundsList();
                    log('result3', `   ✅ 声音列表获取成功，共 ${sounds.length} 个声音`);
                } else {
                    log('result3', '   ❌ 声音列表获取失败', false);
                }
                
                log('result3', '3. 检查Worker相关函数...');
                if (typeof syncSpritesToWorker === 'function') {
                    log('result3', '   ✅ syncSpritesToWorker 函数可用');
                } else {
                    log('result3', '   ❌ syncSpritesToWorker 函数不可用', false);
                }
                
                if (typeof syncSoundsToWorker === 'function') {
                    log('result3', '   ✅ syncSoundsToWorker 函数可用');
                } else {
                    log('result3', '   ❌ syncSoundsToWorker 函数不可用', false);
                }
                
                log('result3', '4. 模拟代码生成...');
                // 这里可以添加更详细的代码生成测试
                log('result3', '   ✅ 代码生成流程检查完成');
                
            } catch (error) {
                log('result3', `❌ 完整流程测试出错: ${error.message}`, false);
            }
            
            log('result3', '完整流程测试完成');
        }
    </script>
</body>
</html> 