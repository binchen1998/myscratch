<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•åŒåå£°éŸ³æ’­æ”¾ä¿®å¤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ æµ‹è¯•åŒåå£°éŸ³æ’­æ”¾ä¿®å¤</h1>
        <p>è¿™ä¸ªæµ‹è¯•éªŒè¯å½“ä¸¤ä¸ªspriteæ’­æ”¾åŒä¸€ä¸ªå£°éŸ³æ–‡ä»¶æ—¶ï¼Œç¨‹åºç»“æŸæ—¶èƒ½æ­£ç¡®åœæ­¢æ‰€æœ‰å£°éŸ³ã€‚</p>
        
        <div class="test-section">
            <h3>æµ‹è¯•å‡†å¤‡</h3>
            <p>é¦–å…ˆéœ€è¦æ·»åŠ ä¸€ä¸ªæµ‹è¯•å£°éŸ³æ–‡ä»¶ï¼š</p>
            <input type="file" id="soundFile" accept="audio/*" style="display: none;">
            <button onclick="document.getElementById('soundFile').click()">é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</button>
            <div id="fileStatus" class="status info" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•1: åŒåå£°éŸ³æ’­æ”¾</h3>
            <p>æ¨¡æ‹Ÿä¸¤ä¸ªspriteåŒæ—¶æ’­æ”¾åŒä¸€ä¸ªå£°éŸ³ï¼š</p>
            <button onclick="testDuplicateSoundPlay()">æ’­æ”¾åŒåå£°éŸ³</button>
            <button onclick="stopAllSounds()">åœæ­¢æ‰€æœ‰å£°éŸ³</button>
            <div id="test1Status" class="status info" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•2: ç¨‹åºç»“æŸæ—¶çš„å£°éŸ³åœæ­¢</h3>
            <p>æ¨¡æ‹Ÿç¨‹åºç»“æŸæ—¶çš„å£°éŸ³åœæ­¢ï¼š</p>
            <button onclick="testProgramStop()">æ¨¡æ‹Ÿç¨‹åºç»“æŸ</button>
            <div id="test2Status" class="status info" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•æ—¥å¿—</h3>
            <div id="testLog" class="log"></div>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script src="sound-manager.js"></script>
    <script>
        // åˆå§‹åŒ–å£°éŸ³ç®¡ç†å™¨
        let testSoundAdded = false;
        
        // æ¨¡æ‹Ÿå£°éŸ³ç®¡ç†å™¨çš„åˆå§‹åŒ–
        function initializeTest() {
            // æ¨¡æ‹Ÿå£°éŸ³æ•°ç»„
            if (!window.sounds) {
                window.sounds = [];
            }
            if (!window.playingSounds) {
                window.playingSounds = new Map();
            }
            if (!window.activeAudioObjects) {
                window.activeAudioObjects = new Set();
            }
            
            log('æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ');
        }
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[æµ‹è¯•] ${message}`);
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
        }
        
        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        document.getElementById('soundFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                log(`é€‰æ‹©æ–‡ä»¶: ${file.name}`);
                
                if (!file.type.startsWith('audio/')) {
                    showStatus('fileStatus', 'è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const audio = new Audio(e.target.result);
                    audio.onloadedmetadata = function() {
                        const soundName = file.name.replace(/\.[^/.]+$/, "");
                        
                        // æ·»åŠ åˆ°å£°éŸ³æ•°ç»„
                        const sound = {
                            id: 'sound_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: soundName,
                            dataURL: e.target.result,
                            duration: audio.duration,
                            audio: null
                        };
                        
                        window.sounds.push(sound);
                        testSoundAdded = true;
                        
                        log(`âœ… å£°éŸ³ "${soundName}" å·²æ·»åŠ ï¼Œæ—¶é•¿: ${audio.duration.toFixed(2)}ç§’`);
                        showStatus('fileStatus', `å£°éŸ³ "${soundName}" å·²æ·»åŠ `, 'success');
                    };
                    audio.onerror = function() {
                        log('âŒ éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥', 'error');
                        showStatus('fileStatus', 'éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥ï¼', 'error');
                    };
                };
                reader.onerror = function() {
                    log('âŒ æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
                    showStatus('fileStatus', 'æ–‡ä»¶è¯»å–å¤±è´¥ï¼', 'error');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // æµ‹è¯•åŒåå£°éŸ³æ’­æ”¾
        function testDuplicateSoundPlay() {
            if (!testSoundAdded) {
                showStatus('test1Status', 'è¯·å…ˆæ·»åŠ ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼', 'error');
                return;
            }
            
            log('å¼€å§‹æµ‹è¯•åŒåå£°éŸ³æ’­æ”¾...');
            showStatus('test1Status', 'æ­£åœ¨æµ‹è¯•åŒåå£°éŸ³æ’­æ”¾...', 'info');
            
            const soundName = window.sounds[0].name;
            
            // ç¬¬ä¸€æ¬¡æ’­æ”¾
            log(`ç¬¬ä¸€æ¬¡æ’­æ”¾å£°éŸ³: ${soundName}`);
            playSoundByName(soundName, false);
            
            // ç­‰å¾…500msåç¬¬äºŒæ¬¡æ’­æ”¾
            setTimeout(() => {
                log(`ç¬¬äºŒæ¬¡æ’­æ”¾åŒåå£°éŸ³: ${soundName}`);
                playSoundByName(soundName, false);
                
                // æ£€æŸ¥æ’­æ”¾å­—å…¸çŠ¶æ€
                setTimeout(() => {
                    const playingCount = window.playingSounds.size;
                    const activeCount = window.activeAudioObjects.size;
                    log(`æ’­æ”¾å­—å…¸ä¸­çš„å£°éŸ³æ•°é‡: ${playingCount}`);
                    log(`æ´»è·ƒéŸ³é¢‘å¯¹è±¡æ•°é‡: ${activeCount}`);
                    
                    if (playingCount === 1 && activeCount === 1) {
                        log('âœ… åŒåå£°éŸ³æ’­æ”¾æµ‹è¯•é€šè¿‡ï¼šåªæœ‰ä¸€ä¸ªå£°éŸ³åœ¨æ’­æ”¾å­—å…¸ä¸­', 'success');
                        showStatus('test1Status', 'åŒåå£°éŸ³æ’­æ”¾æµ‹è¯•é€šè¿‡ï¼', 'success');
                    } else {
                        log(`âŒ åŒåå£°éŸ³æ’­æ”¾æµ‹è¯•å¤±è´¥ï¼šæ’­æ”¾å­—å…¸ä¸­æœ‰${playingCount}ä¸ªå£°éŸ³ï¼Œæ´»è·ƒå¯¹è±¡æœ‰${activeCount}ä¸ª`, 'error');
                        showStatus('test1Status', 'åŒåå£°éŸ³æ’­æ”¾æµ‹è¯•å¤±è´¥ï¼', 'error');
                    }
                }, 1000);
            }, 500);
        }
        
        // æµ‹è¯•ç¨‹åºç»“æŸæ—¶çš„å£°éŸ³åœæ­¢
        function testProgramStop() {
            if (!testSoundAdded) {
                showStatus('test2Status', 'è¯·å…ˆæ·»åŠ ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼', 'error');
                return;
            }
            
            log('å¼€å§‹æµ‹è¯•ç¨‹åºç»“æŸæ—¶çš„å£°éŸ³åœæ­¢...');
            showStatus('test2Status', 'æ­£åœ¨æµ‹è¯•ç¨‹åºç»“æŸæ—¶çš„å£°éŸ³åœæ­¢...', 'info');
            
            const soundName = window.sounds[0].name;
            
            // æ’­æ”¾å£°éŸ³
            log(`æ’­æ”¾å£°éŸ³: ${soundName}`);
            playSoundByName(soundName, false);
            
            // ç­‰å¾…1ç§’åæ¨¡æ‹Ÿç¨‹åºç»“æŸ
            setTimeout(() => {
                log('æ¨¡æ‹Ÿç¨‹åºç»“æŸï¼Œåœæ­¢æ‰€æœ‰å£°éŸ³...');
                stopAllSounds();
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å£°éŸ³éƒ½å·²åœæ­¢
                setTimeout(() => {
                    const playingCount = window.playingSounds.size;
                    const activeCount = window.activeAudioObjects.size;
                    log(`åœæ­¢åæ’­æ”¾å­—å…¸ä¸­çš„å£°éŸ³æ•°é‡: ${playingCount}`);
                    log(`åœæ­¢åæ´»è·ƒéŸ³é¢‘å¯¹è±¡æ•°é‡: ${activeCount}`);
                    
                    if (playingCount === 0 && activeCount === 0) {
                        log('âœ… ç¨‹åºç»“æŸå£°éŸ³åœæ­¢æµ‹è¯•é€šè¿‡ï¼šæ‰€æœ‰å£°éŸ³éƒ½å·²åœæ­¢', 'success');
                        showStatus('test2Status', 'ç¨‹åºç»“æŸå£°éŸ³åœæ­¢æµ‹è¯•é€šè¿‡ï¼', 'success');
                    } else {
                        log(`âŒ ç¨‹åºç»“æŸå£°éŸ³åœæ­¢æµ‹è¯•å¤±è´¥ï¼šè¿˜æœ‰${playingCount}ä¸ªå£°éŸ³åœ¨æ’­æ”¾å­—å…¸ä¸­ï¼Œ${activeCount}ä¸ªæ´»è·ƒå¯¹è±¡`, 'error');
                        showStatus('test2Status', 'ç¨‹åºç»“æŸå£°éŸ³åœæ­¢æµ‹è¯•å¤±è´¥ï¼', 'error');
                    }
                }, 500);
            }, 1000);
        }
        
        // åˆå§‹åŒ–æµ‹è¯•
        initializeTest();
    </script>
</body>
</html> 