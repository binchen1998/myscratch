<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单同名声音测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 10px; padding: 10px 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>🎵 同名声音播放测试</h1>
    
    <button onclick="testDuplicateSound()">测试同名声音播放</button>
    <button onclick="stopAllSounds()">停止所有声音</button>
    <button onclick="clearLog()">清空日志</button>
    
    <div id="log" class="log"></div>

    <script>
        // 模拟声音管理器的核心功能
        let sounds = [];
        let playingSounds = new Map();
        let activeAudioObjects = new Set();
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // 创建测试声音
        function createTestSound() {
            // 创建一个简单的音频上下文来生成测试声音
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.type = 'sine';
            
            // 创建音频数据URL（模拟）
            const testSound = {
                id: 'test_sound_1',
                name: 'test_sound',
                dataURL: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT',
                duration: 2,
                audio: null
            };
            
            sounds.push(testSound);
            log('✅ 测试声音已创建');
        }
        
        // 修复后的playSoundByName函数
        function playSoundByName(name, waitUntilDone = false) {
            log(`🎵 开始播放声音: ${name}`);
            log(`🎵 当前正在播放的声音数量: ${playingSounds.size}`);
            
            // 检查是否已经有同名声音在播放，如果有就先停止它
            if (playingSounds.has(name)) {
                log(`🎵 发现同名声音正在播放: ${name}，先停止它`);
                const existingAudio = playingSounds.get(name);
                try {
                    existingAudio.pause();
                    existingAudio.currentTime = 0;
                    playingSounds.delete(name);
                    activeAudioObjects.delete(existingAudio);
                    log(`🎵 ✅ 已停止同名声音: ${name}`);
                } catch (error) {
                    log(`🎵 ❌ 停止同名声音失败: ${name} - ${error.message}`);
                }
            }
            
            // 创建新的音频对象
            const audio = new Audio();
            audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT';
            
            // 将音频对象添加到播放字典中
            playingSounds.set(name, audio);
            log(`🎵 ✅ 音频对象已添加到播放字典: ${name}`);
            
            // 同时添加到活跃音频对象集合
            activeAudioObjects.add(audio);
            log(`🎵 ✅ 音频对象已添加到活跃集合，当前数量: ${activeAudioObjects.size}`);
            
            // 设置播放结束事件
            audio.onended = () => {
                log(`🎵 音频播放结束: ${name}`);
                playingSounds.delete(name);
                activeAudioObjects.delete(audio);
                log(`🎵 音频对象已从播放字典移除: ${name}`);
            };
            
            audio.onerror = () => {
                log(`🎵 音频播放错误: ${name}`);
                playingSounds.delete(name);
                activeAudioObjects.delete(audio);
                log(`🎵 音频对象已从播放字典移除: ${name}`);
            };
            
            // 开始播放
            audio.play().catch(error => {
                log(`🎵 音频播放失败: ${name} - ${error.message}`);
                playingSounds.delete(name);
                activeAudioObjects.delete(audio);
            });
            
            log(`🎵 播放声音完成: ${name}`);
        }
        
        // 停止所有声音
        function stopAllSounds() {
            log('🛑 开始停止所有声音');
            log(`🛑 当前声音列表长度: ${sounds.length}`);
            log(`🛑 正在播放的声音数量: ${playingSounds.size}`);
            log(`🛑 活跃音频对象数量: ${activeAudioObjects.size}`);
            
            // 停止所有正在播放的声音
            const playingSoundNames = Array.from(playingSounds.keys());
            log(`🛑 正在播放的声音: ${playingSoundNames.join(', ')}`);
            
            let stoppedPlayingCount = 0;
            playingSoundNames.forEach(soundName => {
                const audio = playingSounds.get(soundName);
                if (audio) {
                    try {
                        audio.pause();
                        audio.currentTime = 0;
                        playingSounds.delete(soundName);
                        activeAudioObjects.delete(audio);
                        stoppedPlayingCount++;
                        log(`🛑 ✅ 成功停止正在播放的声音: ${soundName}`);
                    } catch (error) {
                        log(`🛑 ❌ 停止正在播放的声音失败: ${soundName} - ${error.message}`);
                    }
                }
            });
            log(`🛑 停止了 ${stoppedPlayingCount} 个正在播放的声音`);
            
            // 清空所有集合
            playingSounds.clear();
            activeAudioObjects.clear();
            log(`🛑 播放字典已清空，活跃音频对象数量现在是 ${activeAudioObjects.size}`);
            
            log('🛑 停止所有声音完成');
        }
        
        // 测试同名声音播放
        function testDuplicateSound() {
            log('🧪 开始测试同名声音播放...');
            
            // 确保有测试声音
            if (sounds.length === 0) {
                createTestSound();
            }
            
            const soundName = 'test_sound';
            
            // 第一次播放
            log('🧪 第一次播放声音');
            playSoundByName(soundName, false);
            
            // 等待1秒后第二次播放
            setTimeout(() => {
                log('🧪 第二次播放同名声音');
                playSoundByName(soundName, false);
                
                // 检查播放字典状态
                setTimeout(() => {
                    const playingCount = playingSounds.size;
                    const activeCount = activeAudioObjects.size;
                    log(`🧪 播放字典中的声音数量: ${playingCount}`);
                    log(`🧪 活跃音频对象数量: ${activeCount}`);
                    
                    if (playingCount === 1 && activeCount === 1) {
                        log('✅ 同名声音播放测试通过：只有一个声音在播放字典中');
                    } else {
                        log(`❌ 同名声音播放测试失败：播放字典中有${playingCount}个声音，活跃对象有${activeCount}个`);
                    }
                }, 1000);
            }, 1000);
        }
        
        // 初始化
        log('🚀 测试环境初始化完成');
    </script>
</body>
</html> 