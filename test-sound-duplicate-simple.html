<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•åŒåå£°éŸ³æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 10px; padding: 10px 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸµ åŒåå£°éŸ³æ’­æ”¾æµ‹è¯•</h1>
    
    <button onclick="testDuplicateSound()">æµ‹è¯•åŒåå£°éŸ³æ’­æ”¾</button>
    <button onclick="stopAllSounds()">åœæ­¢æ‰€æœ‰å£°éŸ³</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    
    <div id="log" class="log"></div>

    <script>
        // æ¨¡æ‹Ÿå£°éŸ³ç®¡ç†å™¨çš„æ ¸å¿ƒåŠŸèƒ½
        let sounds = [];
        let playingSounds = new Map();
        let activeAudioObjects = new Set();
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // åˆ›å»ºæµ‹è¯•å£°éŸ³
        function createTestSound() {
            // åˆ›å»ºä¸€ä¸ªç®€å•çš„éŸ³é¢‘ä¸Šä¸‹æ–‡æ¥ç”Ÿæˆæµ‹è¯•å£°éŸ³
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.type = 'sine';
            
            // åˆ›å»ºéŸ³é¢‘æ•°æ®URLï¼ˆæ¨¡æ‹Ÿï¼‰
            const testSound = {
                id: 'test_sound_1',
                name: 'test_sound',
                dataURL: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT',
                duration: 2,
                audio: null
            };
            
            sounds.push(testSound);
            log('âœ… æµ‹è¯•å£°éŸ³å·²åˆ›å»º');
        }
        
        // ä¿®å¤åçš„playSoundByNameå‡½æ•°
        function playSoundByName(name, waitUntilDone = false) {
            log(`ğŸµ å¼€å§‹æ’­æ”¾å£°éŸ³: ${name}`);
            log(`ğŸµ å½“å‰æ­£åœ¨æ’­æ”¾çš„å£°éŸ³æ•°é‡: ${playingSounds.size}`);
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰åŒåå£°éŸ³åœ¨æ’­æ”¾ï¼Œå¦‚æœæœ‰å°±å…ˆåœæ­¢å®ƒ
            if (playingSounds.has(name)) {
                log(`ğŸµ å‘ç°åŒåå£°éŸ³æ­£åœ¨æ’­æ”¾: ${name}ï¼Œå…ˆåœæ­¢å®ƒ`);
                const existingAudio = playingSounds.get(name);
                try {
                    existingAudio.pause();
                    existingAudio.currentTime = 0;
                    playingSounds.delete(name);
                    activeAudioObjects.delete(existingAudio);
                    log(`ğŸµ âœ… å·²åœæ­¢åŒåå£°éŸ³: ${name}`);
                } catch (error) {
                    log(`ğŸµ âŒ åœæ­¢åŒåå£°éŸ³å¤±è´¥: ${name} - ${error.message}`);
                }
            }
            
            // åˆ›å»ºæ–°çš„éŸ³é¢‘å¯¹è±¡
            const audio = new Audio();
            audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT';
            
            // å°†éŸ³é¢‘å¯¹è±¡æ·»åŠ åˆ°æ’­æ”¾å­—å…¸ä¸­
            playingSounds.set(name, audio);
            log(`ğŸµ âœ… éŸ³é¢‘å¯¹è±¡å·²æ·»åŠ åˆ°æ’­æ”¾å­—å…¸: ${name}`);
            
            // åŒæ—¶æ·»åŠ åˆ°æ´»è·ƒéŸ³é¢‘å¯¹è±¡é›†åˆ
            activeAudioObjects.add(audio);
            log(`ğŸµ âœ… éŸ³é¢‘å¯¹è±¡å·²æ·»åŠ åˆ°æ´»è·ƒé›†åˆï¼Œå½“å‰æ•°é‡: ${activeAudioObjects.size}`);
            
            // è®¾ç½®æ’­æ”¾ç»“æŸäº‹ä»¶
            audio.onended = () => {
                log(`ğŸµ éŸ³é¢‘æ’­æ”¾ç»“æŸ: ${name}`);
                playingSounds.delete(name);
                activeAudioObjects.delete(audio);
                log(`ğŸµ éŸ³é¢‘å¯¹è±¡å·²ä»æ’­æ”¾å­—å…¸ç§»é™¤: ${name}`);
            };
            
            audio.onerror = () => {
                log(`ğŸµ éŸ³é¢‘æ’­æ”¾é”™è¯¯: ${name}`);
                playingSounds.delete(name);
                activeAudioObjects.delete(audio);
                log(`ğŸµ éŸ³é¢‘å¯¹è±¡å·²ä»æ’­æ”¾å­—å…¸ç§»é™¤: ${name}`);
            };
            
            // å¼€å§‹æ’­æ”¾
            audio.play().catch(error => {
                log(`ğŸµ éŸ³é¢‘æ’­æ”¾å¤±è´¥: ${name} - ${error.message}`);
                playingSounds.delete(name);
                activeAudioObjects.delete(audio);
            });
            
            log(`ğŸµ æ’­æ”¾å£°éŸ³å®Œæˆ: ${name}`);
        }
        
        // åœæ­¢æ‰€æœ‰å£°éŸ³
        function stopAllSounds() {
            log('ğŸ›‘ å¼€å§‹åœæ­¢æ‰€æœ‰å£°éŸ³');
            log(`ğŸ›‘ å½“å‰å£°éŸ³åˆ—è¡¨é•¿åº¦: ${sounds.length}`);
            log(`ğŸ›‘ æ­£åœ¨æ’­æ”¾çš„å£°éŸ³æ•°é‡: ${playingSounds.size}`);
            log(`ğŸ›‘ æ´»è·ƒéŸ³é¢‘å¯¹è±¡æ•°é‡: ${activeAudioObjects.size}`);
            
            // åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„å£°éŸ³
            const playingSoundNames = Array.from(playingSounds.keys());
            log(`ğŸ›‘ æ­£åœ¨æ’­æ”¾çš„å£°éŸ³: ${playingSoundNames.join(', ')}`);
            
            let stoppedPlayingCount = 0;
            playingSoundNames.forEach(soundName => {
                const audio = playingSounds.get(soundName);
                if (audio) {
                    try {
                        audio.pause();
                        audio.currentTime = 0;
                        playingSounds.delete(soundName);
                        activeAudioObjects.delete(audio);
                        stoppedPlayingCount++;
                        log(`ğŸ›‘ âœ… æˆåŠŸåœæ­¢æ­£åœ¨æ’­æ”¾çš„å£°éŸ³: ${soundName}`);
                    } catch (error) {
                        log(`ğŸ›‘ âŒ åœæ­¢æ­£åœ¨æ’­æ”¾çš„å£°éŸ³å¤±è´¥: ${soundName} - ${error.message}`);
                    }
                }
            });
            log(`ğŸ›‘ åœæ­¢äº† ${stoppedPlayingCount} ä¸ªæ­£åœ¨æ’­æ”¾çš„å£°éŸ³`);
            
            // æ¸…ç©ºæ‰€æœ‰é›†åˆ
            playingSounds.clear();
            activeAudioObjects.clear();
            log(`ğŸ›‘ æ’­æ”¾å­—å…¸å·²æ¸…ç©ºï¼Œæ´»è·ƒéŸ³é¢‘å¯¹è±¡æ•°é‡ç°åœ¨æ˜¯ ${activeAudioObjects.size}`);
            
            log('ğŸ›‘ åœæ­¢æ‰€æœ‰å£°éŸ³å®Œæˆ');
        }
        
        // æµ‹è¯•åŒåå£°éŸ³æ’­æ”¾
        function testDuplicateSound() {
            log('ğŸ§ª å¼€å§‹æµ‹è¯•åŒåå£°éŸ³æ’­æ”¾...');
            
            // ç¡®ä¿æœ‰æµ‹è¯•å£°éŸ³
            if (sounds.length === 0) {
                createTestSound();
            }
            
            const soundName = 'test_sound';
            
            // ç¬¬ä¸€æ¬¡æ’­æ”¾
            log('ğŸ§ª ç¬¬ä¸€æ¬¡æ’­æ”¾å£°éŸ³');
            playSoundByName(soundName, false);
            
            // ç­‰å¾…1ç§’åç¬¬äºŒæ¬¡æ’­æ”¾
            setTimeout(() => {
                log('ğŸ§ª ç¬¬äºŒæ¬¡æ’­æ”¾åŒåå£°éŸ³');
                playSoundByName(soundName, false);
                
                // æ£€æŸ¥æ’­æ”¾å­—å…¸çŠ¶æ€
                setTimeout(() => {
                    const playingCount = playingSounds.size;
                    const activeCount = activeAudioObjects.size;
                    log(`ğŸ§ª æ’­æ”¾å­—å…¸ä¸­çš„å£°éŸ³æ•°é‡: ${playingCount}`);
                    log(`ğŸ§ª æ´»è·ƒéŸ³é¢‘å¯¹è±¡æ•°é‡: ${activeCount}`);
                    
                    if (playingCount === 1 && activeCount === 1) {
                        log('âœ… åŒåå£°éŸ³æ’­æ”¾æµ‹è¯•é€šè¿‡ï¼šåªæœ‰ä¸€ä¸ªå£°éŸ³åœ¨æ’­æ”¾å­—å…¸ä¸­');
                    } else {
                        log(`âŒ åŒåå£°éŸ³æ’­æ”¾æµ‹è¯•å¤±è´¥ï¼šæ’­æ”¾å­—å…¸ä¸­æœ‰${playingCount}ä¸ªå£°éŸ³ï¼Œæ´»è·ƒå¯¹è±¡æœ‰${activeCount}ä¸ª`);
                    }
                }, 1000);
            }, 1000);
        }
        
        // åˆå§‹åŒ–
        log('ğŸš€ æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html> 