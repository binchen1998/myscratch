<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声音停止调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>声音停止调试</h1>
    
    <div class="test-section">
        <h2>测试声音停止功能</h2>
        <button onclick="testSoundStop()">测试声音停止</button>
        <button onclick="clearLog()">清除日志</button>
        <div id="log" class="log">调试日志将在这里显示...</div>
    </div>

    <script>
        // 模拟声音管理功能
        let sounds = [
            {
                id: 'sound_1',
                name: 'karen',
                dataURL: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT',
                duration: 2.5
            }
        ];
        
        let activeAudioObjects = new Set();
        let currentPlayingAudio = null;
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
        }
        
        // 模拟播放声音
        function mockPlaySoundByName(name, waitUntilDone = false) {
            log(`🎵 开始播放声音: ${name}`);
            log(`🎵 waitUntilDone: ${waitUntilDone}`);
            log(`🎵 当前活跃音频对象数量: ${activeAudioObjects.size}`);
            
            const sound = sounds.find(s => s.name === name);
            if (sound) {
                log(`🎵 找到声音: ${name}, 时长: ${sound.duration}秒`);
                
                const audio = {
                    name: name,
                    paused: false,
                    currentTime: 0,
                    pause: function() {
                        this.paused = true;
                        log(`🎵 暂停音频: ${this.name}`);
                    },
                    play: function() {
                        this.paused = false;
                        log(`🎵 播放音频: ${this.name}`);
                        return Promise.resolve();
                    }
                };
                
                // 添加到活跃集合
                activeAudioObjects.add(audio);
                log(`🎵 ✅ 音频对象已添加到活跃集合，当前数量: ${activeAudioObjects.size}`);
                
                // 模拟播放
                audio.play();
                
                // 模拟播放结束
                setTimeout(() => {
                    log(`🎵 音频播放结束: ${name}`);
                    activeAudioObjects.delete(audio);
                    log(`🎵 音频对象已从活跃集合移除，当前数量: ${activeAudioObjects.size}`);
                }, sound.duration * 1000);
                
            } else {
                log(`🎵 ❌ 未找到声音: ${name}`);
            }
        }
        
        // 模拟停止所有声音
        function mockStopAllSounds() {
            log('🎵 ===== 开始停止所有声音 =====');
            log(`🎵 当前声音列表长度: ${sounds.length}`);
            log(`🎵 活跃音频对象数量: ${activeAudioObjects.size}`);
            log(`🎵 当前播放音频: ${currentPlayingAudio ? '存在' : '不存在'}`);
            
            // 停止所有活跃的音频对象
            log(`🎵 步骤1: 停止 ${activeAudioObjects.size} 个活跃音频对象`);
            let stoppedCount = 0;
            activeAudioObjects.forEach((audio, index) => {
                try {
                    log(`🎵 停止活跃音频对象 ${index + 1}: ${audio.name}`);
                    audio.pause();
                    audio.currentTime = 0;
                    stoppedCount++;
                    log(`🎵 ✅ 成功停止活跃音频对象 ${index + 1}`);
                } catch (error) {
                    log(`🎵 ❌ 停止活跃音频对象 ${index + 1} 失败: ${error.message}`);
                }
            });
            log(`🎵 步骤1完成: 停止了 ${stoppedCount} 个活跃音频对象`);
            
            // 清空活跃音频对象集合
            log('🎵 步骤2: 清空活跃音频对象集合');
            activeAudioObjects.clear();
            log(`🎵 步骤2完成: 活跃音频对象数量现在是 ${activeAudioObjects.size}`);
            
            log('🎵 ===== 停止所有声音完成 =====');
        }
        
        function testSoundStop() {
            clearLog();
            log('开始测试声音停止功能...');
            
            // 播放声音
            log('1. 播放声音...');
            mockPlaySoundByName('karen', false);
            
            // 等待一段时间后停止
            setTimeout(() => {
                log('2. 停止所有声音...');
                mockStopAllSounds();
                
                log('3. 验证停止结果...');
                const allStopped = activeAudioObjects.size === 0;
                if (allStopped) {
                    log('✅ 所有声音都已正确停止');
                } else {
                    log('❌ 部分声音未正确停止');
                }
                
                log(`活跃音频对象数量: ${activeAudioObjects.size}`);
                log('测试完成');
            }, 1000);
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('声音停止调试页面已加载');
        });
    </script>
</body>
</html> 