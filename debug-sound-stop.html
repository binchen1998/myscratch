<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£°éŸ³åœæ­¢è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>å£°éŸ³åœæ­¢è°ƒè¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•å£°éŸ³åœæ­¢åŠŸèƒ½</h2>
        <button onclick="testSoundStop()">æµ‹è¯•å£°éŸ³åœæ­¢</button>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="log" class="log">è°ƒè¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
    </div>

    <script>
        // æ¨¡æ‹Ÿå£°éŸ³ç®¡ç†åŠŸèƒ½
        let sounds = [
            {
                id: 'sound_1',
                name: 'karen',
                dataURL: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT',
                duration: 2.5
            }
        ];
        
        let activeAudioObjects = new Set();
        let currentPlayingAudio = null;
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
        }
        
        // æ¨¡æ‹Ÿæ’­æ”¾å£°éŸ³
        function mockPlaySoundByName(name, waitUntilDone = false) {
            log(`ğŸµ å¼€å§‹æ’­æ”¾å£°éŸ³: ${name}`);
            log(`ğŸµ waitUntilDone: ${waitUntilDone}`);
            log(`ğŸµ å½“å‰æ´»è·ƒéŸ³é¢‘å¯¹è±¡æ•°é‡: ${activeAudioObjects.size}`);
            
            const sound = sounds.find(s => s.name === name);
            if (sound) {
                log(`ğŸµ æ‰¾åˆ°å£°éŸ³: ${name}, æ—¶é•¿: ${sound.duration}ç§’`);
                
                const audio = {
                    name: name,
                    paused: false,
                    currentTime: 0,
                    pause: function() {
                        this.paused = true;
                        log(`ğŸµ æš‚åœéŸ³é¢‘: ${this.name}`);
                    },
                    play: function() {
                        this.paused = false;
                        log(`ğŸµ æ’­æ”¾éŸ³é¢‘: ${this.name}`);
                        return Promise.resolve();
                    }
                };
                
                // æ·»åŠ åˆ°æ´»è·ƒé›†åˆ
                activeAudioObjects.add(audio);
                log(`ğŸµ âœ… éŸ³é¢‘å¯¹è±¡å·²æ·»åŠ åˆ°æ´»è·ƒé›†åˆï¼Œå½“å‰æ•°é‡: ${activeAudioObjects.size}`);
                
                // æ¨¡æ‹Ÿæ’­æ”¾
                audio.play();
                
                // æ¨¡æ‹Ÿæ’­æ”¾ç»“æŸ
                setTimeout(() => {
                    log(`ğŸµ éŸ³é¢‘æ’­æ”¾ç»“æŸ: ${name}`);
                    activeAudioObjects.delete(audio);
                    log(`ğŸµ éŸ³é¢‘å¯¹è±¡å·²ä»æ´»è·ƒé›†åˆç§»é™¤ï¼Œå½“å‰æ•°é‡: ${activeAudioObjects.size}`);
                }, sound.duration * 1000);
                
            } else {
                log(`ğŸµ âŒ æœªæ‰¾åˆ°å£°éŸ³: ${name}`);
            }
        }
        
        // æ¨¡æ‹Ÿåœæ­¢æ‰€æœ‰å£°éŸ³
        function mockStopAllSounds() {
            log('ğŸµ ===== å¼€å§‹åœæ­¢æ‰€æœ‰å£°éŸ³ =====');
            log(`ğŸµ å½“å‰å£°éŸ³åˆ—è¡¨é•¿åº¦: ${sounds.length}`);
            log(`ğŸµ æ´»è·ƒéŸ³é¢‘å¯¹è±¡æ•°é‡: ${activeAudioObjects.size}`);
            log(`ğŸµ å½“å‰æ’­æ”¾éŸ³é¢‘: ${currentPlayingAudio ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            
            // åœæ­¢æ‰€æœ‰æ´»è·ƒçš„éŸ³é¢‘å¯¹è±¡
            log(`ğŸµ æ­¥éª¤1: åœæ­¢ ${activeAudioObjects.size} ä¸ªæ´»è·ƒéŸ³é¢‘å¯¹è±¡`);
            let stoppedCount = 0;
            activeAudioObjects.forEach((audio, index) => {
                try {
                    log(`ğŸµ åœæ­¢æ´»è·ƒéŸ³é¢‘å¯¹è±¡ ${index + 1}: ${audio.name}`);
                    audio.pause();
                    audio.currentTime = 0;
                    stoppedCount++;
                    log(`ğŸµ âœ… æˆåŠŸåœæ­¢æ´»è·ƒéŸ³é¢‘å¯¹è±¡ ${index + 1}`);
                } catch (error) {
                    log(`ğŸµ âŒ åœæ­¢æ´»è·ƒéŸ³é¢‘å¯¹è±¡ ${index + 1} å¤±è´¥: ${error.message}`);
                }
            });
            log(`ğŸµ æ­¥éª¤1å®Œæˆ: åœæ­¢äº† ${stoppedCount} ä¸ªæ´»è·ƒéŸ³é¢‘å¯¹è±¡`);
            
            // æ¸…ç©ºæ´»è·ƒéŸ³é¢‘å¯¹è±¡é›†åˆ
            log('ğŸµ æ­¥éª¤2: æ¸…ç©ºæ´»è·ƒéŸ³é¢‘å¯¹è±¡é›†åˆ');
            activeAudioObjects.clear();
            log(`ğŸµ æ­¥éª¤2å®Œæˆ: æ´»è·ƒéŸ³é¢‘å¯¹è±¡æ•°é‡ç°åœ¨æ˜¯ ${activeAudioObjects.size}`);
            
            log('ğŸµ ===== åœæ­¢æ‰€æœ‰å£°éŸ³å®Œæˆ =====');
        }
        
        function testSoundStop() {
            clearLog();
            log('å¼€å§‹æµ‹è¯•å£°éŸ³åœæ­¢åŠŸèƒ½...');
            
            // æ’­æ”¾å£°éŸ³
            log('1. æ’­æ”¾å£°éŸ³...');
            mockPlaySoundByName('karen', false);
            
            // ç­‰å¾…ä¸€æ®µæ—¶é—´ååœæ­¢
            setTimeout(() => {
                log('2. åœæ­¢æ‰€æœ‰å£°éŸ³...');
                mockStopAllSounds();
                
                log('3. éªŒè¯åœæ­¢ç»“æœ...');
                const allStopped = activeAudioObjects.size === 0;
                if (allStopped) {
                    log('âœ… æ‰€æœ‰å£°éŸ³éƒ½å·²æ­£ç¡®åœæ­¢');
                } else {
                    log('âŒ éƒ¨åˆ†å£°éŸ³æœªæ­£ç¡®åœæ­¢');
                }
                
                log(`æ´»è·ƒéŸ³é¢‘å¯¹è±¡æ•°é‡: ${activeAudioObjects.size}`);
                log('æµ‹è¯•å®Œæˆ');
            }, 1000);
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('å£°éŸ³åœæ­¢è°ƒè¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html> 