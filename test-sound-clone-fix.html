<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•å£°éŸ³å…‹éš†ä¿®å¤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æµ‹è¯•å£°éŸ³å…‹éš†ä¿®å¤</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>è¿™ä¸ªæµ‹è¯•ç”¨äºéªŒè¯ HTMLAudioElement å…‹éš†é”™è¯¯æ˜¯å¦å·²ä¿®å¤ã€‚</p>
        <p>é—®é¢˜ï¼šå½“å£°éŸ³è¢«æ’­æ”¾åï¼ŒHTMLAudioElement å¯¹è±¡ä¼šè¢«å­˜å‚¨åœ¨å£°éŸ³æ•°æ®ä¸­ï¼Œå¯¼è‡´æ— æ³•é€šè¿‡ postMessage å‘é€åˆ° Workerã€‚</p>
        <p>è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿ getSoundsList() å‡½æ•°å§‹ç»ˆè¿”å›å¯åºåˆ—åŒ–çš„æ•°æ®ï¼Œä¸åŒ…å« HTMLAudioElement å¯¹è±¡ã€‚</p>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•æ­¥éª¤</h2>
        <button onclick="testGetSoundsList()">1. æµ‹è¯• getSoundsList() å‡½æ•°</button>
        <button onclick="testPlaySound()">2. æ’­æ”¾å£°éŸ³</button>
        <button onclick="testGetSoundsListAfterPlay()">3. æ’­æ”¾åå†æ¬¡æµ‹è¯• getSoundsList()</button>
        <button onclick="testWorkerMessage()">4. æµ‹è¯• Worker æ¶ˆæ¯å‘é€</button>
        <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="testResults"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿå£°éŸ³ç®¡ç†å™¨çš„ sounds æ•°ç»„
        let sounds = [];
        let testResults = [];

        // æ¨¡æ‹Ÿ getSoundsList å‡½æ•°ï¼ˆä¿®å¤åçš„ç‰ˆæœ¬ï¼‰
        function getSoundsList() {
            return sounds.map(sound => {
                // ç¡®ä¿è¿”å›çš„å¯¹è±¡ä¸åŒ…å«ä»»ä½•HTMLAudioElementå¯¹è±¡
                const cleanSound = {
                    id: sound.id,
                    name: sound.name,
                    dataURL: sound.dataURL,
                    duration: sound.duration
                };
                
                // éªŒè¯æ•°æ®å®Œæ•´æ€§
                if (!cleanSound.id || !cleanSound.name || !cleanSound.dataURL) {
                    console.warn('[å£°éŸ³ç®¡ç†] å£°éŸ³æ•°æ®ä¸å®Œæ•´:', cleanSound);
                }
                
                return cleanSound;
            });
        }

        // æ¨¡æ‹Ÿæ·»åŠ å£°éŸ³
        function addTestSound() {
            const sound = {
                id: 'test_sound_' + Date.now(),
                name: 'æµ‹è¯•å£°éŸ³',
                dataURL: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT',
                duration: 1.0,
                audio: null
            };
            sounds.push(sound);
            logResult('info', `æ·»åŠ æµ‹è¯•å£°éŸ³: ${sound.name}`);
        }

        // æ¨¡æ‹Ÿæ’­æ”¾å£°éŸ³
        function playTestSound() {
            if (sounds.length > 0) {
                const sound = sounds[0];
                // æ¨¡æ‹Ÿåˆ›å»º HTMLAudioElement
                sound.audio = new Audio(sound.dataURL);
                logResult('info', `æ’­æ”¾å£°éŸ³: ${sound.name} (å·²åˆ›å»º HTMLAudioElement)`);
            }
        }

        // æµ‹è¯• getSoundsList å‡½æ•°
        function testGetSoundsList() {
            try {
                const soundsList = getSoundsList();
                const serialized = JSON.stringify(soundsList);
                
                logResult('success', `âœ… getSoundsList() æµ‹è¯•é€šè¿‡`);
                logResult('info', `è¿”å›æ•°æ®: ${JSON.stringify(soundsList, null, 2)}`);
                logResult('info', `åºåˆ—åŒ–æˆåŠŸ: ${serialized.length} å­—ç¬¦`);
                
                return true;
            } catch (error) {
                logResult('error', `âŒ getSoundsList() æµ‹è¯•å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        // æµ‹è¯•æ’­æ”¾å£°éŸ³
        function testPlaySound() {
            try {
                playTestSound();
                logResult('success', `âœ… å£°éŸ³æ’­æ”¾æµ‹è¯•é€šè¿‡`);
                return true;
            } catch (error) {
                logResult('error', `âŒ å£°éŸ³æ’­æ”¾æµ‹è¯•å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        // æ’­æ”¾åæµ‹è¯• getSoundsList
        function testGetSoundsListAfterPlay() {
            try {
                const soundsList = getSoundsList();
                const serialized = JSON.stringify(soundsList);
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å« audio å±æ€§
                const hasAudioProperty = soundsList.some(sound => 'audio' in sound);
                
                if (hasAudioProperty) {
                    logResult('error', `âŒ æ’­æ”¾å getSoundsList() ä»ç„¶åŒ…å« audio å±æ€§`);
                    return false;
                }
                
                logResult('success', `âœ… æ’­æ”¾å getSoundsList() æµ‹è¯•é€šè¿‡`);
                logResult('info', `è¿”å›æ•°æ®: ${JSON.stringify(soundsList, null, 2)}`);
                logResult('info', `åºåˆ—åŒ–æˆåŠŸ: ${serialized.length} å­—ç¬¦`);
                
                return true;
            } catch (error) {
                logResult('error', `âŒ æ’­æ”¾å getSoundsList() æµ‹è¯•å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        // æµ‹è¯• Worker æ¶ˆæ¯å‘é€
        function testWorkerMessage() {
            try {
                const soundsList = getSoundsList();
                
                // æ¨¡æ‹Ÿ postMessage è°ƒç”¨
                const message = {
                    type: 'INIT_SPRITES',
                    data: {
                        sprites: [],
                        backgrounds: [],
                        sounds: soundsList
                    }
                };
                
                // å°è¯•åºåˆ—åŒ–æ•´ä¸ªæ¶ˆæ¯
                const serialized = JSON.stringify(message);
                
                logResult('success', `âœ… Worker æ¶ˆæ¯å‘é€æµ‹è¯•é€šè¿‡`);
                logResult('info', `æ¶ˆæ¯å¤§å°: ${serialized.length} å­—ç¬¦`);
                
                return true;
            } catch (error) {
                logResult('error', `âŒ Worker æ¶ˆæ¯å‘é€æµ‹è¯•å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        function runAllTests() {
            clearResults();
            
            logResult('info', 'ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            
            // æ·»åŠ æµ‹è¯•å£°éŸ³
            addTestSound();
            
            // æµ‹è¯• 1: getSoundsList
            const test1 = testGetSoundsList();
            
            // æµ‹è¯• 2: æ’­æ”¾å£°éŸ³
            const test2 = testPlaySound();
            
            // æµ‹è¯• 3: æ’­æ”¾å getSoundsList
            const test3 = testGetSoundsListAfterPlay();
            
            // æµ‹è¯• 4: Worker æ¶ˆæ¯å‘é€
            const test4 = testWorkerMessage();
            
            // æ€»ç»“
            const allPassed = test1 && test2 && test3 && test4;
            
            if (allPassed) {
                logResult('success', 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼HTMLAudioElement å…‹éš†é—®é¢˜å·²ä¿®å¤ã€‚');
            } else {
                logResult('error', 'âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ã€‚');
            }
        }

        // è®°å½•æµ‹è¯•ç»“æœ
        function logResult(type, message) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
            
            console.log(`[æµ‹è¯•] ${message}`);
        }

        // æ¸…é™¤æµ‹è¯•ç»“æœ
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            logResult('info', 'æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
        };
    </script>
</body>
</html> 