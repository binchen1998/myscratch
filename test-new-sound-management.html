<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新声音管理方案测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.playing {
            background: #d4edda;
            color: #155724;
        }
        .status.stopped {
            background: #f8d7da;
            color: #721c24;
        }
        .status.ready {
            background: #d1ecf1;
            color: #0c5460;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .sound-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .sound-item {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🎵 新声音管理方案测试</h1>
    
    <div class="container">
        <h2>测试说明</h2>
        <p>这个测试验证新的声音管理方案：</p>
        <ul>
            <li>使用全局播放字典管理正在播放的声音</li>
            <li>支持播放不存在的声音（创建默认音频）</li>
            <li>精确停止特定声音或所有声音</li>
            <li>程序结束时清理所有音频资源</li>
        </ul>
    </div>

    <div class="container">
        <h2>控制按钮</h2>
        <button class="success" onclick="playSound('karen')">🎵 播放 karen</button>
        <button class="success" onclick="playSound('music')">🎵 播放 music</button>
        <button class="success" onclick="playSound('beep')">🎵 播放 beep</button>
        <button onclick="stopSound('karen')">⏹️ 停止 karen</button>
        <button onclick="stopSound('music')">⏹️ 停止 music</button>
        <button class="danger" onclick="stopAllSounds()">⏹️ 停止所有声音</button>
        <button onclick="clearLog()">🧹 清除日志</button>
        
        <div id="status" class="status ready">准备就绪</div>
    </div>

    <div class="container">
        <h2>当前状态</h2>
        <div>正在播放的声音数量: <span id="playingCount">0</span></div>
        <div>播放字典内容: <span id="playingList">无</span></div>
        <div class="sound-list" id="soundList"></div>
    </div>

    <div class="container">
        <h2>执行日志</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        // 模拟新的声音管理系统
        let playingSounds = new Map(); // 播放字典：{ 声音名称: audio对象 }
        let activeAudioObjects = new Set(); // 活跃音频对象集合
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'ready') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function updatePlayingInfo() {
            document.getElementById('playingCount').textContent = playingSounds.size;
            const playingNames = Array.from(playingSounds.keys());
            document.getElementById('playingList').textContent = playingNames.length > 0 ? playingNames.join(', ') : '无';
            
            const soundListDiv = document.getElementById('soundList');
            soundListDiv.innerHTML = '';
            playingNames.forEach(name => {
                const soundItem = document.createElement('div');
                soundItem.className = 'sound-item';
                soundItem.textContent = name;
                soundListDiv.appendChild(soundItem);
            });
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function playSound(name) {
            log(`🎵 ===== 开始播放声音: ${name} =====`);
            updateStatus(`正在播放: ${name}`, 'playing');
            
            // 创建音频对象
            let audio;
            if (name === 'karen') {
                // 模拟不存在的声音，创建默认音频
                log(`🎵 声音 ${name} 不存在，创建默认音频对象`);
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                oscillator.type = 'sine';
                
                // 创建虚拟音频对象
                audio = {
                    play: () => {
                        oscillator.start();
                        setTimeout(() => {
                            oscillator.stop();
                            oscillator.disconnect();
                            playingSounds.delete(name);
                            activeAudioObjects.delete(audio);
                            log(`🎵 默认音频播放结束: ${name}`);
                            updatePlayingInfo();
                        }, 2000);
                        return Promise.resolve();
                    },
                    pause: () => {
                        oscillator.stop();
                        oscillator.disconnect();
                        playingSounds.delete(name);
                        activeAudioObjects.delete(audio);
                        log(`🎵 默认音频已暂停: ${name}`);
                        updatePlayingInfo();
                    },
                    currentTime: 0,
                    onended: null,
                    onerror: null
                };
            } else {
                // 创建真实的音频对象
                audio = new Audio();
                audio.src = `data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT`;
                audio.loop = true;
                
                audio.onended = () => {
                    log(`🎵 音频播放结束: ${name}`);
                    playingSounds.delete(name);
                    activeAudioObjects.delete(audio);
                    updatePlayingInfo();
                };
                audio.onerror = () => {
                    log(`🎵 音频播放错误: ${name}`);
                    playingSounds.delete(name);
                    activeAudioObjects.delete(audio);
                    updatePlayingInfo();
                };
            }
            
            // 添加到播放字典
            playingSounds.set(name, audio);
            activeAudioObjects.add(audio);
            log(`🎵 ✅ 音频对象已添加到播放字典: ${name}`);
            log(`🎵 当前正在播放的声音:`, Array.from(playingSounds.keys()));
            updatePlayingInfo();
            
            // 开始播放
            audio.play().catch(error => {
                log(`🎵 ❌ 音频播放失败: ${name}`, error);
                playingSounds.delete(name);
                activeAudioObjects.delete(audio);
                updatePlayingInfo();
            });
            
            log(`🎵 ===== 播放声音完成: ${name} =====`);
        }
        
        function stopSound(name) {
            log(`⏹️ ===== 停止特定声音: ${name} =====`);
            
            const audio = playingSounds.get(name);
            if (audio) {
                log(`🎵 找到正在播放的声音: ${name}`);
                try {
                    audio.pause();
                    audio.currentTime = 0;
                    playingSounds.delete(name);
                    activeAudioObjects.delete(audio);
                    log(`🎵 ✅ 成功停止声音: ${name}`);
                    updateStatus(`已停止: ${name}`, 'stopped');
                } catch (error) {
                    log(`🎵 ❌ 停止声音失败: ${name}`, error);
                }
            } else {
                log(`🎵 声音 ${name} 没有在播放`);
            }
            
            updatePlayingInfo();
            log(`⏹️ ===== 停止特定声音完成: ${name} =====`);
        }
        
        function stopAllSounds() {
            log(`⏹️ ===== 开始停止所有声音 =====`);
            updateStatus('正在停止所有声音...', 'stopped');
            
            // 方法1: 使用播放字典停止所有正在播放的声音
            log(`🎵 方法1: 使用播放字典停止所有正在播放的声音`);
            const playingSoundNames = Array.from(playingSounds.keys());
            log(`🎵 正在播放的声音:`, playingSoundNames);
            
            let stoppedPlayingCount = 0;
            playingSoundNames.forEach(soundName => {
                const audio = playingSounds.get(soundName);
                if (audio) {
                    try {
                        audio.pause();
                        audio.currentTime = 0;
                        playingSounds.delete(soundName);
                        activeAudioObjects.delete(audio);
                        stoppedPlayingCount++;
                        log(`🎵 ✅ 成功停止正在播放的声音: ${soundName}`);
                    } catch (error) {
                        log(`🎵 ❌ 停止正在播放的声音失败: ${soundName}`, error);
                    }
                }
            });
            log(`🎵 方法1完成: 停止了 ${stoppedPlayingCount} 个正在播放的声音`);
            
            // 方法2: 使用浏览器API停止所有媒体
            log(`🎵 方法2: 使用浏览器API停止所有媒体`);
            try {
                const allMedia = document.querySelectorAll('audio, video');
                log(`🎵 找到 ${allMedia.length} 个媒体元素`);
                allMedia.forEach((media, index) => {
                    try {
                        media.pause();
                        media.currentTime = 0;
                        log(`🎵 ✅ 停止媒体元素 ${index + 1}`);
                    } catch (error) {
                        log(`🎵 ⚠️ 停止媒体元素 ${index + 1} 失败:`, error);
                    }
                });
            } catch (error) {
                log(`🎵 ⚠️ 浏览器API停止媒体失败:`, error);
            }
            
            // 清空所有集合
            log(`🎵 清空所有音频对象集合`);
            playingSounds.clear();
            activeAudioObjects.clear();
            
            updatePlayingInfo();
            updateStatus('所有声音已停止', 'ready');
            log(`⏹️ ===== 停止所有声音完成 =====`);
        }
        
        // 页面加载完成
        window.addEventListener('load', function() {
            log('🚀 测试页面加载完成');
            log('📋 测试说明: 点击播放按钮测试声音管理，点击停止按钮验证停止功能');
            updatePlayingInfo();
        });
    </script>
</body>
</html> 