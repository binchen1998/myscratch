<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker声音功能修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>Worker声音功能修复测试</h1>
    
    <div class="test-section">
        <h2>测试1：Worker消息通信</h2>
        <button onclick="testWorkerMessage()">测试Worker消息</button>
        <div id="result1" class="result">结果将在这里显示...</div>
    </div>
    
    <div class="test-section">
        <h2>测试2：声音函数模拟</h2>
        <button onclick="testSoundFunctions()">测试声音函数</button>
        <div id="result2" class="result">结果将在这里显示...</div>
    </div>
    
    <div class="test-section">
        <h2>测试3：完整流程测试</h2>
        <button onclick="testFullFlow()">测试完整流程</button>
        <div id="result3" class="result">结果将在这里显示...</div>
    </div>

    <script>
        function log(elementId, message, isSuccess = null) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (isSuccess === true) {
                element.className = 'result success';
            } else if (isSuccess === false) {
                element.className = 'result error';
            } else {
                element.className = 'result';
            }
            
            element.textContent += logMessage;
            console.log(message);
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
            document.getElementById(elementId).className = 'result';
        }
        
        // 模拟Worker中的声音函数
        let mockSounds = [
            { id: 'sound_1', name: 'karen', dataURL: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT', duration: 2.5 }
        ];
        
        let currentVolume = 1.0;
        let isPlaying = false;
        
        // 模拟Worker中的声音函数
        function mockPlaySoundByName(name, waitUntilDone = false) {
            const sound = mockSounds.find(s => s.name === name);
            if (sound) {
                log('result2', `🎵 模拟播放声音: ${name}`, true);
                isPlaying = true;
                
                // 模拟发送消息到主线程
                if (window.parent && window.parent.postMessage) {
                    window.parent.postMessage({
                        type: 'PLAY_SOUND',
                        soundName: name,
                        soundData: sound.dataURL,
                        waitUntilDone: waitUntilDone
                    }, '*');
                }
                
                if (waitUntilDone) {
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            log('result2', `🎵 声音播放完成: ${name}`, true);
                            isPlaying = false;
                            resolve();
                        }, sound.duration * 1000);
                    });
                }
            } else {
                log('result2', `❌ 未找到声音: ${name}`, false);
            }
        }
        
        function mockStopAllSounds() {
            log('result2', '🎵 模拟停止所有声音', true);
            isPlaying = false;
            
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'STOP_ALL_SOUNDS'
                }, '*');
            }
        }
        
        function mockSetVolume(volume) {
            currentVolume = Math.max(0, Math.min(1, volume / 100));
            log('result2', `🎵 模拟设置音量: ${volume}% (${currentVolume})`, true);
            
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'SET_VOLUME',
                    volume: currentVolume
                }, '*');
            }
        }
        
        function mockGetVolume() {
            log('result2', `🎵 模拟获取音量: ${Math.round(currentVolume * 100)}%`, true);
            return Math.round(currentVolume * 100);
        }
        
        // 测试1：Worker消息通信
        function testWorkerMessage() {
            clearLog('result1');
            log('result1', '开始测试Worker消息通信...');
            
            // 模拟Worker发送消息
            const testMessages = [
                { type: 'PLAY_SOUND', soundName: 'karen', soundData: 'test', waitUntilDone: false },
                { type: 'STOP_ALL_SOUNDS' },
                { type: 'SET_VOLUME', volume: 0.5 }
            ];
            
            testMessages.forEach((msg, index) => {
                log('result1', `发送消息 ${index + 1}: ${msg.type}`);
                
                // 模拟主线程处理消息
                switch (msg.type) {
                    case 'PLAY_SOUND':
                        log('result1', `  ✅ 处理播放声音消息: ${msg.soundName}`, true);
                        break;
                    case 'STOP_ALL_SOUNDS':
                        log('result1', `  ✅ 处理停止声音消息`, true);
                        break;
                    case 'SET_VOLUME':
                        log('result1', `  ✅ 处理设置音量消息: ${msg.volume}`, true);
                        break;
                }
            });
            
            log('result1', 'Worker消息通信测试完成');
        }
        
        // 测试2：声音函数模拟
        function testSoundFunctions() {
            clearLog('result2');
            log('result2', '开始测试声音函数模拟...');
            
            // 测试播放声音
            mockPlaySoundByName('karen', false);
            
            setTimeout(() => {
                // 测试设置音量
                mockSetVolume(50);
                
                setTimeout(() => {
                    // 测试获取音量
                    const volume = mockGetVolume();
                    log('result2', `当前音量: ${volume}%`);
                    
                    setTimeout(() => {
                        // 测试停止声音
                        mockStopAllSounds();
                        log('result2', '声音函数模拟测试完成');
                    }, 1000);
                }, 1000);
            }, 1000);
        }
        
        // 测试3：完整流程测试
        function testFullFlow() {
            clearLog('result3');
            log('result3', '开始测试完整流程...');
            
            // 模拟完整的代码执行流程
            log('result3', '1. 生成声音积木代码...');
            const soundCode = `playSoundByName('karen', false);\n`;
            log('result3', `   生成的代码: ${soundCode.trim()}`);
            
            log('result3', '2. 在Worker中执行代码...');
            // 模拟在Worker中执行代码
            try {
                // 这里我们模拟代码执行
                log('result3', '   ✅ 代码执行成功');
                log('result3', '   🎵 发送播放声音消息到主线程');
                
                // 模拟主线程接收消息
                log('result3', '3. 主线程接收消息...');
                log('result3', '   ✅ 消息接收成功');
                log('result3', '   🎵 调用主线程的播放声音函数');
                
            } catch (error) {
                log('result3', `   ❌ 代码执行失败: ${error.message}`, false);
            }
            
            log('result3', '完整流程测试完成');
        }
        
        // 监听来自父窗口的消息
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type) {
                log('result1', `收到消息: ${event.data.type}`, true);
            }
        });
    </script>
</body>
</html> 