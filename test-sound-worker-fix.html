<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workerå£°éŸ³åŠŸèƒ½ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>Workerå£°éŸ³åŠŸèƒ½ä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•1ï¼šWorkeræ¶ˆæ¯é€šä¿¡</h2>
        <button onclick="testWorkerMessage()">æµ‹è¯•Workeræ¶ˆæ¯</button>
        <div id="result1" class="result">ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•2ï¼šå£°éŸ³å‡½æ•°æ¨¡æ‹Ÿ</h2>
        <button onclick="testSoundFunctions()">æµ‹è¯•å£°éŸ³å‡½æ•°</button>
        <div id="result2" class="result">ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•3ï¼šå®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <button onclick="testFullFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
        <div id="result3" class="result">ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
    </div>

    <script>
        function log(elementId, message, isSuccess = null) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (isSuccess === true) {
                element.className = 'result success';
            } else if (isSuccess === false) {
                element.className = 'result error';
            } else {
                element.className = 'result';
            }
            
            element.textContent += logMessage;
            console.log(message);
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
            document.getElementById(elementId).className = 'result';
        }
        
        // æ¨¡æ‹ŸWorkerä¸­çš„å£°éŸ³å‡½æ•°
        let mockSounds = [
            { id: 'sound_1', name: 'karen', dataURL: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT', duration: 2.5 }
        ];
        
        let currentVolume = 1.0;
        let isPlaying = false;
        
        // æ¨¡æ‹ŸWorkerä¸­çš„å£°éŸ³å‡½æ•°
        function mockPlaySoundByName(name, waitUntilDone = false) {
            const sound = mockSounds.find(s => s.name === name);
            if (sound) {
                log('result2', `ğŸµ æ¨¡æ‹Ÿæ’­æ”¾å£°éŸ³: ${name}`, true);
                isPlaying = true;
                
                // æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹
                if (window.parent && window.parent.postMessage) {
                    window.parent.postMessage({
                        type: 'PLAY_SOUND',
                        soundName: name,
                        soundData: sound.dataURL,
                        waitUntilDone: waitUntilDone
                    }, '*');
                }
                
                if (waitUntilDone) {
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            log('result2', `ğŸµ å£°éŸ³æ’­æ”¾å®Œæˆ: ${name}`, true);
                            isPlaying = false;
                            resolve();
                        }, sound.duration * 1000);
                    });
                }
            } else {
                log('result2', `âŒ æœªæ‰¾åˆ°å£°éŸ³: ${name}`, false);
            }
        }
        
        function mockStopAllSounds() {
            log('result2', 'ğŸµ æ¨¡æ‹Ÿåœæ­¢æ‰€æœ‰å£°éŸ³', true);
            isPlaying = false;
            
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'STOP_ALL_SOUNDS'
                }, '*');
            }
        }
        
        function mockSetVolume(volume) {
            currentVolume = Math.max(0, Math.min(1, volume / 100));
            log('result2', `ğŸµ æ¨¡æ‹Ÿè®¾ç½®éŸ³é‡: ${volume}% (${currentVolume})`, true);
            
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'SET_VOLUME',
                    volume: currentVolume
                }, '*');
            }
        }
        
        function mockGetVolume() {
            log('result2', `ğŸµ æ¨¡æ‹Ÿè·å–éŸ³é‡: ${Math.round(currentVolume * 100)}%`, true);
            return Math.round(currentVolume * 100);
        }
        
        // æµ‹è¯•1ï¼šWorkeræ¶ˆæ¯é€šä¿¡
        function testWorkerMessage() {
            clearLog('result1');
            log('result1', 'å¼€å§‹æµ‹è¯•Workeræ¶ˆæ¯é€šä¿¡...');
            
            // æ¨¡æ‹ŸWorkerå‘é€æ¶ˆæ¯
            const testMessages = [
                { type: 'PLAY_SOUND', soundName: 'karen', soundData: 'test', waitUntilDone: false },
                { type: 'STOP_ALL_SOUNDS' },
                { type: 'SET_VOLUME', volume: 0.5 }
            ];
            
            testMessages.forEach((msg, index) => {
                log('result1', `å‘é€æ¶ˆæ¯ ${index + 1}: ${msg.type}`);
                
                // æ¨¡æ‹Ÿä¸»çº¿ç¨‹å¤„ç†æ¶ˆæ¯
                switch (msg.type) {
                    case 'PLAY_SOUND':
                        log('result1', `  âœ… å¤„ç†æ’­æ”¾å£°éŸ³æ¶ˆæ¯: ${msg.soundName}`, true);
                        break;
                    case 'STOP_ALL_SOUNDS':
                        log('result1', `  âœ… å¤„ç†åœæ­¢å£°éŸ³æ¶ˆæ¯`, true);
                        break;
                    case 'SET_VOLUME':
                        log('result1', `  âœ… å¤„ç†è®¾ç½®éŸ³é‡æ¶ˆæ¯: ${msg.volume}`, true);
                        break;
                }
            });
            
            log('result1', 'Workeræ¶ˆæ¯é€šä¿¡æµ‹è¯•å®Œæˆ');
        }
        
        // æµ‹è¯•2ï¼šå£°éŸ³å‡½æ•°æ¨¡æ‹Ÿ
        function testSoundFunctions() {
            clearLog('result2');
            log('result2', 'å¼€å§‹æµ‹è¯•å£°éŸ³å‡½æ•°æ¨¡æ‹Ÿ...');
            
            // æµ‹è¯•æ’­æ”¾å£°éŸ³
            mockPlaySoundByName('karen', false);
            
            setTimeout(() => {
                // æµ‹è¯•è®¾ç½®éŸ³é‡
                mockSetVolume(50);
                
                setTimeout(() => {
                    // æµ‹è¯•è·å–éŸ³é‡
                    const volume = mockGetVolume();
                    log('result2', `å½“å‰éŸ³é‡: ${volume}%`);
                    
                    setTimeout(() => {
                        // æµ‹è¯•åœæ­¢å£°éŸ³
                        mockStopAllSounds();
                        log('result2', 'å£°éŸ³å‡½æ•°æ¨¡æ‹Ÿæµ‹è¯•å®Œæˆ');
                    }, 1000);
                }, 1000);
            }, 1000);
        }
        
        // æµ‹è¯•3ï¼šå®Œæ•´æµç¨‹æµ‹è¯•
        function testFullFlow() {
            clearLog('result3');
            log('result3', 'å¼€å§‹æµ‹è¯•å®Œæ•´æµç¨‹...');
            
            // æ¨¡æ‹Ÿå®Œæ•´çš„ä»£ç æ‰§è¡Œæµç¨‹
            log('result3', '1. ç”Ÿæˆå£°éŸ³ç§¯æœ¨ä»£ç ...');
            const soundCode = `playSoundByName('karen', false);\n`;
            log('result3', `   ç”Ÿæˆçš„ä»£ç : ${soundCode.trim()}`);
            
            log('result3', '2. åœ¨Workerä¸­æ‰§è¡Œä»£ç ...');
            // æ¨¡æ‹Ÿåœ¨Workerä¸­æ‰§è¡Œä»£ç 
            try {
                // è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿä»£ç æ‰§è¡Œ
                log('result3', '   âœ… ä»£ç æ‰§è¡ŒæˆåŠŸ');
                log('result3', '   ğŸµ å‘é€æ’­æ”¾å£°éŸ³æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹');
                
                // æ¨¡æ‹Ÿä¸»çº¿ç¨‹æ¥æ”¶æ¶ˆæ¯
                log('result3', '3. ä¸»çº¿ç¨‹æ¥æ”¶æ¶ˆæ¯...');
                log('result3', '   âœ… æ¶ˆæ¯æ¥æ”¶æˆåŠŸ');
                log('result3', '   ğŸµ è°ƒç”¨ä¸»çº¿ç¨‹çš„æ’­æ”¾å£°éŸ³å‡½æ•°');
                
            } catch (error) {
                log('result3', `   âŒ ä»£ç æ‰§è¡Œå¤±è´¥: ${error.message}`, false);
            }
            
            log('result3', 'å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆ');
        }
        
        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type) {
                log('result1', `æ”¶åˆ°æ¶ˆæ¯: ${event.data.type}`, true);
            }
        });
    </script>
</body>
</html> 