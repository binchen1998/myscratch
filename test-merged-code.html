<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆå¹¶ä»£ç åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.error {
            background: #dc3545;
        }
        .code-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>åˆå¹¶ä»£ç åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>åŠŸèƒ½è¯´æ˜</h2>
        <p>è¿™ä¸ªæµ‹è¯•é¡µé¢ç”¨äºéªŒè¯åˆå¹¶ä»£ç åŠŸèƒ½çš„æ­£ç¡®æ€§ã€‚åˆå¹¶ä»£ç åŠŸèƒ½å¯ä»¥å°†æ‰€æœ‰spriteçš„ä»£ç åˆå¹¶åˆ°ä¸€ä¸ªJavaScriptæ–‡ä»¶ä¸­ã€‚</p>
        
        <div class="status info">
            <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong>
            <ol>
                <li>ç‚¹å‡»"ç”Ÿæˆæµ‹è¯•ä»£ç "æŒ‰é’®ç”Ÿæˆç¤ºä¾‹åˆå¹¶ä»£ç </li>
                <li>æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç ç»“æ„</li>
                <li>ç‚¹å‡»"ä¸‹è½½æµ‹è¯•ä»£ç "ä¿å­˜æ–‡ä»¶</li>
                <li>åœ¨ä¸»åº”ç”¨ä¸­æµ‹è¯•è¿è¡Œåˆå¹¶ä»£ç </li>
            </ol>
        </div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•ä»£ç ç”Ÿæˆ</h2>
        <button class="test-button" onclick="generateTestCode()">ç”Ÿæˆæµ‹è¯•ä»£ç </button>
        <button class="test-button" onclick="downloadTestCode()" id="downloadBtn" disabled>ä¸‹è½½æµ‹è¯•ä»£ç </button>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div id="codePreview" class="code-preview" style="display: none;">
            <h3>ç”Ÿæˆçš„åˆå¹¶ä»£ç é¢„è§ˆï¼š</h3>
            <pre id="codeContent"></pre>
        </div>
    </div>
    
    <div class="test-section">
        <h2>åŠŸèƒ½ç‰¹ç‚¹</h2>
        <ul>
            <li><strong>æ€§èƒ½ä¼˜åŒ–</strong> - å‡å°‘ä»£ç ç”Ÿæˆæ—¶é—´ï¼Œæ‰§è¡Œæ›´é«˜æ•ˆ</li>
            <li><strong>è°ƒè¯•å‹å¥½</strong> - æ‰€æœ‰ä»£ç åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¾¿äºæŸ¥çœ‹å’Œè°ƒè¯•</li>
            <li><strong>åˆ†äº«ä¾¿åˆ©</strong> - å¯ä»¥ç”Ÿæˆç‹¬ç«‹çš„JSæ–‡ä»¶ï¼Œä¾¿äºåˆ†äº«å’Œéƒ¨ç½²</li>
            <li><strong>ç®€åŒ–éƒ¨ç½²</strong> - å‡å°‘æ–‡ä»¶ä¾èµ–ï¼Œæ›´å®¹æ˜“éƒ¨ç½²</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>ä½¿ç”¨æ–¹æ³•</h2>
        <ol>
            <li>åœ¨ä¸»åº”ç”¨ä¸­åˆ›å»ºé¡¹ç›®ï¼Œæ·»åŠ ç²¾çµå¹¶ç¼–å†™ä»£ç </li>
            <li>ç‚¹å‡»é¡¶éƒ¨å·¥å…·æ çš„ <strong>"ğŸ“„ ä¿å­˜ä»£ç "</strong> æŒ‰é’®</li>
            <li>ç³»ç»Ÿä¼šè‡ªåŠ¨ç”ŸæˆåŒ…å«æ‰€æœ‰ç²¾çµä»£ç çš„JavaScriptæ–‡ä»¶</li>
            <li>ç‚¹å‡» <strong>"â–¶ è¿è¡Œä»£ç "</strong> æŒ‰é’®é€‰æ‹©å¹¶è¿è¡Œåˆå¹¶ä»£ç æ–‡ä»¶</li>
        </ol>
    </div>

    <script>
        let generatedCode = '';
        
        function generateTestCode() {
            // æ¨¡æ‹Ÿç”Ÿæˆåˆå¹¶ä»£ç 
            generatedCode = `// åˆå¹¶çš„ç²¾çµä»£ç  - è‡ªåŠ¨ç”Ÿæˆ
// ç”Ÿæˆæ—¶é—´: ${new Date().toISOString()}
// åŒ…å« 2 ä¸ªç²¾çµ

(function() {
    // å…¨å±€å˜é‡
    let sprites = [];
    let variables = {};
    let isRunning = false;
    let messageSystem = {
        listeners: new Map(),
        pendingMessages: new Map(),
        messageHistory: [],
        maxHistory: 100
    };
    let keyEventSystem = {
        listeners: new Map(),
        pressedKeys: new Set()
    };
    let spriteClickEventSystem = {
        listeners: new Map()
    };
    
    // å·¥å…·å‡½æ•°
    function sleep(seconds) {
        return new Promise(resolve => setTimeout(resolve, seconds * 1000));
    }
    
    function addMessageListener(messageName, callback) {
        if (!messageSystem.listeners.has(messageName)) {
            messageSystem.listeners.set(messageName, []);
        }
        messageSystem.listeners.get(messageName).push(callback);
    }
    
    function broadcastMessage(messageName) {
        const listeners = messageSystem.listeners.get(messageName) || [];
        listeners.forEach(callback => {
            try {
                callback(messageName);
            } catch (error) {
                console.error('æ¶ˆæ¯å¤„ç†é”™è¯¯:', error);
            }
        });
    }
    
    function registerKeyEvent(key, callback) {
        if (!keyEventSystem.listeners.has(key)) {
            keyEventSystem.listeners.set(key, []);
        }
        keyEventSystem.listeners.get(key).push(callback);
    }
    
    function registerSpriteClickEvent(callback) {
        spriteClickEventSystem.listeners.set('click', callback);
    }
    
    // ç²¾çµæ“ä½œå‡½æ•°
    function moveTo(x, y) {
        postMessage({
            type: 'SPRITE_UPDATE',
            spriteId: currentSpriteId,
            state: { x: x, y: y }
        });
    }
    
    function rotate(degrees) {
        postMessage({
            type: 'SPRITE_UPDATE',
            spriteId: currentSpriteId,
            state: { rotation: degrees }
        });
    }
    
    function say(message) {
        postMessage({
            type: 'SPRITE_SAY',
            spriteId: currentSpriteId,
            message: message,
            bubbleType: 'say'
        });
    }
    
    function think(message) {
        postMessage({
            type: 'SPRITE_SAY',
            spriteId: currentSpriteId,
            message: message,
            bubbleType: 'think'
        });
    }
    
    function showVariable(varName) {
        postMessage({
            type: 'SHOW_VARIABLE',
            varName: varName,
            value: variables[varName] || 0
        });
    }
    
    function updateVariableDisplay(varName, variables) {
        postMessage({
            type: 'UPDATE_VARIABLE',
            varName: varName,
            value: variables[varName] || 0
        });
    }
    
    // æ•°å­¦å‡½æ•°
    function abs(x) { return Math.abs(x); }
    function floor(x) { return Math.floor(x); }
    function ceil(x) { return Math.ceil(x); }
    function round(x) { return Math.round(x); }
    function sqrt(x) { return Math.sqrt(x); }
    function sin(x) { return Math.sin(x * Math.PI / 180); }
    function cos(x) { return Math.cos(x * Math.PI / 180); }
    function tan(x) { return Math.tan(x * Math.PI / 180); }
    
    // å¸¸é‡
    const PI = Math.PI;
    const E = Math.E;
    
    // å½“å‰æ‰§è¡Œçš„ç²¾çµID
    let currentSpriteId = null;
    
    // åˆå§‹åŒ–ç²¾çµæ•°æ®
    sprites.push({
        id: 'sprite1',
        name: 'æµ‹è¯•ç²¾çµ1',
        x: 0,
        y: 0,
        rotation: 0,
        scale: 1.0,
        visible: true,
        currentCostumeIndex: 0
    });
    
    sprites.push({
        id: 'sprite2',
        name: 'æµ‹è¯•ç²¾çµ2',
        x: 100,
        y: 100,
        rotation: 0,
        scale: 1.0,
        visible: true,
        currentCostumeIndex: 0
    });
    
    // ç²¾çµä»£ç 
    // ç²¾çµ æµ‹è¯•ç²¾çµ1 - ç¨‹åºå¼€å§‹å— 1
    (async function() {
        currentSpriteId = 'sprite1';
        await say('ä½ å¥½ï¼Œæˆ‘æ˜¯ç²¾çµ1ï¼');
        await sleep(1);
        await moveTo(100, 0);
        await sleep(1);
        await rotate(90);
        await say('æˆ‘ç§»åŠ¨äº†ï¼');
    })();
    
    // ç²¾çµ æµ‹è¯•ç²¾çµ2 - ç¨‹åºå¼€å§‹å— 1
    (async function() {
        currentSpriteId = 'sprite2';
        await sleep(0.5);
        await say('ä½ å¥½ï¼Œæˆ‘æ˜¯ç²¾çµ2ï¼');
        await sleep(1);
        await moveTo(0, 100);
        await sleep(1);
        await rotate(-90);
        await say('æˆ‘ä¹Ÿç§»åŠ¨äº†ï¼');
    })();
    
    // æ¶ˆæ¯ç›‘å¬å™¨
    addMessageListener('æµ‹è¯•æ¶ˆæ¯', async function() {
        currentSpriteId = 'sprite1';
        await say('æ”¶åˆ°æ¶ˆæ¯äº†ï¼');
    });
    
    // é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
    registerKeyEvent('space', async function() {
        currentSpriteId = 'sprite1';
        await say('ç©ºæ ¼é”®è¢«æŒ‰ä¸‹äº†ï¼');
    });
    
    // åˆå§‹åŒ–å®Œæˆ
    console.log('åˆå¹¶ä»£ç åˆå§‹åŒ–å®Œæˆï¼ŒåŒ…å« 2 ä¸ªç²¾çµ');
})();`;
            
            // æ˜¾ç¤ºçŠ¶æ€
            const status = document.getElementById('status');
            status.className = 'status success';
            status.innerHTML = '<strong>æˆåŠŸï¼</strong> æµ‹è¯•ä»£ç å·²ç”Ÿæˆã€‚';
            status.style.display = 'block';
            
            // æ˜¾ç¤ºä»£ç é¢„è§ˆ
            const codePreview = document.getElementById('codePreview');
            const codeContent = document.getElementById('codeContent');
            codeContent.textContent = generatedCode;
            codePreview.style.display = 'block';
            
            // å¯ç”¨ä¸‹è½½æŒ‰é’®
            document.getElementById('downloadBtn').disabled = false;
        }
        
        function downloadTestCode() {
            if (!generatedCode) {
                alert('è¯·å…ˆç”Ÿæˆæµ‹è¯•ä»£ç ï¼');
                return;
            }
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([generatedCode], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æµ‹è¯•åˆå¹¶ä»£ç _${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.js`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // æ˜¾ç¤ºçŠ¶æ€
            const status = document.getElementById('status');
            status.className = 'status success';
            status.innerHTML = '<strong>æˆåŠŸï¼</strong> æµ‹è¯•ä»£ç æ–‡ä»¶å·²ä¸‹è½½ã€‚';
            status.style.display = 'block';
        }
    </script>
</body>
</html> 